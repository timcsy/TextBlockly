# TextBlockly v0.1.3 發布說明

## 🎉 重要修復與改進

這個版本主要解決了變數處理的關鍵問題，並新增了完整的 Arduino 函數積木庫。

### 🐛 關鍵問題修復

#### 1. 變數名稱顯示問題 ✅
- **問題**: 積木轉換回程式碼時顯示錯誤的變數名稱（如 `K3BqTBQSglavA`）
- **原因**: Blockly 變數系統的內部 ID 與顯示名稱不一致
- **解決**: 實現了變數預處理機制，確保 XML 載入前創建正確的變數映射

#### 2. 全域變數錯誤提升 ✅
- **問題**: 函數內的變數被錯誤地提升為全域變數
- **影響**: `int inChar = Serial.read();` 等變數出現在程式碼頂部
- **解決**: 改進了變數範圍檢測，只有真正的全域變數才會被提升

#### 3. JavaScript 語法錯誤 ✅
- **問題**: `mode` 變數重複宣告導致的語法錯誤
- **解決**: 重新命名變數避免命名衝突

#### 4. 積木連接問題 ✅
- **問題**: `variables_define` 積木缺少連接屬性導致積木鏈斷裂
- **解決**: 添加了 `previousStatement` 和 `nextStatement` 屬性

### ✨ 新功能與改進

#### 系統性 Arduino 積木庫
新增了 40+ 個 Arduino 函數積木，涵蓋：

**數學函數** (7個)
- `map()` - 數值映射
- `constrain()` - 數值限制
- `min()`, `max()` - 最小/最大值
- `abs()` - 絕對值
- `pow()` - 次方運算
- `sqrt()` - 平方根

**時間函數** (2個)
- `millis()` - 取得執行時間(毫秒)
- `micros()` - 取得執行時間(微秒)

**隨機數函數** (2個)
- `random()` - 生成隨機數
- `randomSeed()` - 設定隨機種子

**Serial 通信擴展** (3個)
- `Serial.available()` - 檢查可讀資料
- `Serial.read()` - 讀取單一位元組
- `Serial.readString()` - 讀取字串

**文字處理積木** (11個)
- 字串連接、長度計算、子字串擷取
- 字元操作、大小寫轉換
- 數字與字串轉換

### 🔧 技術改進

#### AST 處理優化
- 改進了 `MEMBER_EXPRESSION` 類型的處理
- 優化了表達式字串生成邏輯
- 增強了錯誤處理和日誌記錄

#### XML 生成改進
- 實現了變數字段的特殊處理
- 優化了積木鏈生成邏輯
- 改進了 XML 載入前的預處理

#### 程式碼生成完善
- 為所有新增積木實現了完整的程式碼生成
- 消除了所有 TODO 註釋
- 統一了前後端程式碼生成邏輯

### 📊 品質指標

- ✅ 編譯無錯誤
- ✅ 完整測試覆蓋
- ✅ 語法錯誤修復
- ✅ 變數處理正常
- ✅ 積木連接正常
- ✅ 程式碼生成完整

### 📦 套件資訊

- **檔案名稱**: `textblockly-0.1.3.vsix`
- **檔案大小**: 5.29MB
- **檔案數量**: 2090 個檔案
- **支援版本**: VS Code 1.74.0+

### 🚀 安裝方式

#### 方法一：從 VSIX 檔案安裝
1. 下載 `textblockly-0.1.3.vsix`
2. 在 VS Code 中按 `Ctrl+Shift+P`
3. 選擇 "Extensions: Install from VSIX..."
4. 選擇下載的 VSIX 檔案

#### 方法二：開發模式安裝
```bash
# 克隆專案
git clone <repository-url>
cd TextBlockly

# 安裝依賴
npm install

# 建置專案
npm run compile

# 在 VS Code 中按 F5 啟動開發模式
```

### 🎯 使用指南

1. **開啟積木編輯器**
   - 建立或開啟 `.ino` 檔案
   - 執行命令: `TextBlockly: Open Blockly View`

2. **程式碼與積木同步**
   - 程式碼 → 積木: `同步到積木`
   - 積木 → 程式碼: `同步到程式碼`

3. **使用新積木**
   - 在工具箱中找到各種分類的積木
   - 拖拽組合建立 Arduino 程式
   - 即時生成對應的 C++ 程式碼

### 📝 已知問題

- 大型專案可能需要較長載入時間（建議啟用 bundling）
- 複雜的巢狀結構可能需要手動調整

### 🔄 下一步計畫

- 實現積木 bundling 以提升效能
- 新增更多感測器和馬達控制積木
- 改進複雜巢狀結構的處理
- 新增積木模板匯入匯出功能

---

**感謝所有使用者的回饋和支持！** 🙏

如有任何問題，請在 GitHub Issues 中回報。